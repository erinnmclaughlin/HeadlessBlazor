@implements IAsyncDisposable
@namespace HeadlessBlazor
@using Microsoft.AspNetCore.Components.Rendering

@code {
    private DotNetObjectReference<HBOutsideClickBehavior>? dotNetObjRef;
    private IJSObjectReference? handlerRef;

    [Inject]
    private IJSRuntime JS { get; set; } = default!;

    [Parameter]
    public IReferenceable Container { get; set; } = default!;

    [Parameter]
    public EventCallback OnClick { get; set; }

    public async ValueTask DisposeAsync()
    {
        if (handlerRef is not null)
        {
            await handlerRef.InvokeVoidAsync("dispose");
            await handlerRef.DisposeAsync();
            handlerRef = null;
        }

        dotNetObjRef?.Dispose();
    }

    [JSInvokable]
    public async void NotifyClickOutside()
    {
        await OnClick.InvokeAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetObjRef ??= DotNetObjectReference.Create(this);
            var moduleName = nameof(HBOutsideClickBehavior);
            var module = await JS.InvokeAsync<IJSObjectReference>("import", $"./_content/HeadlessBlazor.Core/Behaviors/OutsideClick/{moduleName}.razor.js");
            handlerRef = await module.InvokeAsync<IJSObjectReference>($"{moduleName}.createInstance", Container.ElementReference, dotNetObjRef);
            await module.DisposeAsync();
        }
    }
}