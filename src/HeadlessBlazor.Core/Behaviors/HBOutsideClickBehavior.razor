@implements IAsyncDisposable
@inherits HBBehaviorBase<HBOutsideClickBehavior>

@code {
    private IJSObjectReference? jsObjRef;
    private DotNetObjectReference<HBOutsideClickBehavior>? objRef;

    [Parameter]
    public ICloseable Closeable { get; set; } = default!;

    public async ValueTask DisposeAsync()
    {
        if (jsObjRef is not null)
        {
            await jsObjRef.InvokeVoidAsync("dispose");
            await jsObjRef.DisposeAsync();
        }

        objRef?.Dispose();
    }

    [JSInvokable]
    public async void NotifyClickOutside()
    {
        await HandleClick();
    }

    protected override void OnInitialized()
    {
        objRef = DotNetObjectReference.Create(this);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            jsObjRef = await LoadFromModuleAsync(module =>
            {
                return module.InvokeAsync<IJSObjectReference>("OutsideClickBehavior.createInstance", Closeable.ElementReference, objRef);
            });
        }
    }

    private Task HandleClick() => Closeable is null ? Task.CompletedTask : Closeable.CloseAsync();
}